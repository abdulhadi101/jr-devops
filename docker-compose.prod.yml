version: '3.8'

services:
  
  # Traefik Overrides (Production)
  traefik:
    # Always restart
    restart: always
    
    # Production Traefik configuration
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # Let's Encrypt configuration
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/certificates/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      
      # Disable dashboard in production
      - "--api.dashboard=false"
      
      # Production logging
      - "--log.level=ERROR"
      - "--accesslog=true"
    
    labels:
      - "prod.environment=production"
  
  # App Overrides (Production)
  app:
    
    build:
      target: production  # Use production stage
    
    # Always restart
    restart: always
    
    volumes: []
    
    # Production environment
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - LOG_LEVEL=warning
    
    # Production Traefik labels (HTTPS + Let's Encrypt)
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.secure-drop.rule=Host(`${TRAEFIK_HOST}`)"
      - "traefik.http.routers.secure-drop.entrypoints=web"
      
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.secure-drop.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      
      # HTTPS router
      - "traefik.http.routers.secure-drop-secure.rule=Host(`${TRAEFIK_HOST}`)"
      - "traefik.http.routers.secure-drop-secure.entrypoints=websecure"
      - "traefik.http.routers.secure-drop-secure.tls=true"
      - "traefik.http.routers.secure-drop-secure.tls.certresolver=letsencrypt"
      
      # Service configuration
      - "traefik.http.services.secure-drop.loadbalancer.server.port=80"
      
      - "prod.environment=production"
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
  
  # Database Overrides (Production)
  db:
    restart: always
    
    ports: []
    
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c work_mem=4MB
      -c maintenance_work_mem=64MB
      -c effective_cache_size=512MB
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    labels:
      - "prod.environment=production"
  
  # Redis Overrides (Production)
  redis:
    # Always restart
    restart: always
    
    # Don't expose ports
    ports: []
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    labels:
      - "prod.environment=production"