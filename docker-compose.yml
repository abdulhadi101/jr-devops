version: '3.8'
services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.2
    
    # Basic Traefik configuration
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
    
    # Ports exposed to host
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "8080:8080"  # Dashboard (local only, disabled in prod)
    
    # Docker socket access
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro 
      - traefik-certificates:/certificates
    
    networks:
      - secure-drop-network
    
    # Health check
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
  
  # Laravel Application
  app:
    # Build configuration
    build:
      context: .             
      dockerfile: Dockerfile 
      target: development    
    
    # Environment variables from file
    env_file: .env.docker
    
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"
      
      # Router configuration (HTTP)
      - "traefik.http.routers.secure-drop.rule=Host(`${TRAEFIK_HOST:-secure-drop.localhost}`)"
      - "traefik.http.routers.secure-drop.entrypoints=web"
      
      # Service configuration
      - "traefik.http.services.secure-drop.loadbalancer.server.port=80"
    
    # Dependencies
    depends_on:
      db:
        condition: service_healthy  # Wait for DB to be healthy
      redis:
        condition: service_healthy  # Wait for Redis to be healthy
    
    networks:
      - secure-drop-network
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s 
  
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    
    # Environment variables
    environment:
      POSTGRES_DB: ${DB_DATABASE:-secure_drop}
      POSTGRES_USER: ${DB_USERNAME:-secure_drop}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    
    # Persistent storage
    volumes:
      - db-data:/var/lib/postgresql/data
    
    networks:
      - secure-drop-network
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-secure_drop}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  
  # Redis Cache
  redis:
    image: redis:7-alpine
    
    # Redis configuration
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    
    # Persistent storage
    volumes:
      - redis-data:/data
    
    networks:
      - secure-drop-network
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

# NETWORKS
networks:
  secure-drop-network:
    driver: bridge

# VOLUMES
volumes:
  db-data:             
  redis-data:          
  traefik-certificates: 